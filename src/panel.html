<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Mock Panel</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius: 8px;
      --radius-lg: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      overflow: hidden;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      padding: 20px 24px;
    }
    .container {
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-shrink: 0;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
    }
    .logo svg { width: 28px; height: 28px; }
    .tabs {
      display: inline-flex;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 4px;
      box-shadow: var(--shadow);
    }
    .tab {
      padding: 8px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: 6px;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      background: var(--primary);
      color: white;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel { display: none; }
    .panel.active { display: block; }
    .toolbar {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
      flex-shrink: 0;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    .search-box svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }
    .search-input {
      width: 100%;
      padding: 9px 12px 9px 38px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .select {
      padding: 9px 32px 9px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 10px center;
      appearance: none;
      cursor: pointer;
      outline: none;
    }
    .select:focus { border-color: var(--primary); }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn svg { width: 16px; height: 16px; }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover { background: var(--bg); color: var(--text); }
    .btn-danger { color: var(--danger); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .list { 
      padding: 8px; 
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }
    .list-item {
      padding: 14px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 4px;
    }
    .list-item:hover { background: var(--bg); }
    .list-item.expanded { background: #f1f5f9; }
    .list-item:last-child { margin-bottom: 0; }
    .item-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-code {
      font-weight: 600;
      font-size: 13px;
      min-width: 32px;
    }
    .status-code.success { color: var(--success); }
    .status-code.error { color: var(--danger); }
    .method-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .method-badge.GET { background: #dbeafe; color: #1d4ed8; }
    .method-badge.POST { background: #fef3c7; color: #b45309; }
    .method-badge.PUT { background: #d1fae5; color: #047857; }
    .method-badge.DELETE { background: #fee2e2; color: #b91c1c; }
    .method-badge.PATCH { background: #e9d5ff; color: #7c3aed; }
    .item-url {
      flex: 1;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tag {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .tag-mock { background: #d1fae5; color: #047857; }
    .tag-real { background: #f1f5f9; color: var(--text-secondary); }
    .item-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
      padding-left: 44px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .item-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    .item-detail {
      display: none;
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .list-item.expanded .item-detail { display: block; }
    .detail-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .detail-content {
      background: #1e293b;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      line-height: 1.6;
      overflow-x: auto;
      max-height: 280px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    /* JSON 语法高亮 */
    .json-key { color: #7dd3fc; }
    .json-string { color: #86efac; }
    .json-number { color: #fcd34d; }
    .json-boolean { color: #f472b6; }
    .json-null { color: #a78bfa; }
    .detail-section { margin-bottom: 12px; }
    .detail-section:last-child { margin-bottom: 0; }

    /* Rule Item */
    .rule-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius);
      margin: 4px 8px;
      background: var(--bg);
    }
    .rule-info { flex: 1; }
    .rule-url {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      font-weight: 500;
    }
    .rule-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    /* Toggle */
    .toggle {
      position: relative;
      width: 40px;
      height: 22px;
      cursor: pointer;
    }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle-track {
      position: absolute;
      inset: 0;
      background: #cbd5e1;
      border-radius: 11px;
      transition: background 0.2s;
    }
    .toggle-thumb {
      position: absolute;
      width: 18px;
      height: 18px;
      left: 2px;
      top: 2px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle input:checked + .toggle-track { background: var(--primary); }
    .toggle input:checked ~ .toggle-thumb { transform: translateX(18px); }
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 640px;
      max-height: calc(100vh - 40px);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: white;
    }
    .form-select {
      appearance: none;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;
      padding-right: 36px;
      cursor: pointer;
    }
    .form-input:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .form-textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      outline: none;
    }
    .form-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .tab-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }
    .tab-btn {
      padding: 6px 14px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .tab-btn:hover { background: var(--bg); }
    .tab-btn.active { background: var(--primary); color: white; }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        Network Mock
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="network">Network</button>
        <button class="tab" data-tab="rules">Rules</button>
      </div>
    </div>

    <div class="card">
      <div id="network-panel" class="panel active">
        <div class="toolbar">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <input type="text" class="search-input" id="log-search" placeholder="Search URL...">
          </div>
          <select class="select" id="log-method-filter">
            <option value="">All Methods</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
          <select class="select" id="log-mock-filter">
            <option value="">All Status</option>
            <option value="mocked">Mocked</option>
            <option value="real">Real</option>
          </select>
          <button class="btn btn-ghost" onclick="clearLogs()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            Clear
          </button>
        </div>
        <div id="logs-list" class="list"></div>
      </div>

      <div id="rules-panel" class="panel">
        <div class="toolbar">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <input type="text" class="search-input" id="rule-search" placeholder="Search URL...">
          </div>
          <select class="select" id="rule-method-filter">
            <option value="">All Methods</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
          <button class="btn btn-primary" onclick="openAddRuleModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Add Rule
          </button>
        </div>
        <div id="rules-list" class="list"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="rule-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Add Mock Rule</div>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rule-id">
        <div class="form-group">
          <label class="form-label">URL Pattern</label>
          <input type="text" class="form-input" id="rule-url" placeholder="/api/users">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Method</label>
            <select class="form-select" id="rule-method">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="DELETE">DELETE</option>
              <option value="PATCH">PATCH</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <input type="number" class="form-input" id="rule-status" value="200">
          </div>
          <div class="form-group">
            <label class="form-label">Delay (ms)</label>
            <input type="number" class="form-input" id="rule-delay" value="0">
          </div>
        </div>
        <div class="form-group">
          <div class="tab-bar">
            <button class="tab-btn active" data-target="body-tab">Response Body</button>
            <button class="tab-btn" data-target="headers-tab">Headers</button>
          </div>
          <div id="body-tab">
            <textarea class="form-textarea" id="rule-response" placeholder='{"code": 200, "data": {}}'></textarea>
          </div>
          <div id="headers-tab" style="display:none;">
            <textarea class="form-textarea" id="rule-headers" placeholder='{"Content-Type": "application/json"}'></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveRule()">Save Rule</button>
      </div>
    </div>
  </div>

  <script>
    let ws, rules = [], logs = [];

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + location.host + '/__network_mock_ws__');
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'rules') { rules = msg.data || []; renderRules(); renderLogs(); }
        else if (msg.type === 'logs') { logs = msg.data || []; renderLogs(); }
        else if (msg.type === 'log') { logs.unshift(msg.data); renderLogs(); }
      };
      ws.onclose = () => setTimeout(connect, 1000);
    }
    connect();

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-panel').classList.add('active');
      });
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('body-tab').style.display = btn.dataset.target === 'body-tab' ? 'block' : 'none';
        document.getElementById('headers-tab').style.display = btn.dataset.target === 'headers-tab' ? 'block' : 'none';
      });
    });

    ['rule-search', 'rule-method-filter'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderRules);
      document.getElementById(id).addEventListener('change', renderRules);
    });
    ['log-search', 'log-method-filter', 'log-mock-filter'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderLogs);
      document.getElementById(id).addEventListener('change', renderLogs);
    });

    function findMatchingRule(url, method) {
      return rules.find(r => r.enabled && r.method === method && url.includes(r.url));
    }

    function findExistingRule(url, method) {
      return rules.find(r => r.method === method && url.includes(r.url));
    }

    function getDeduplicatedLogs(filteredLogs) {
      const seen = new Map(), result = [];
      for (const log of filteredLogs) {
        const key = `${log.method}:${log.url}`;
        if (log.isMocked) {
          if (!seen.has(key)) { seen.set(key, true); result.push(log); }
        } else { result.push(log); }
      }
      return result;
    }

    function renderRules() {
      const search = document.getElementById('rule-search').value.toLowerCase();
      const method = document.getElementById('rule-method-filter').value;
      const filtered = rules.filter(r => {
        if (search && !r.url.toLowerCase().includes(search)) return false;
        if (method && r.method !== method) return false;
        return true;
      });
      const container = document.getElementById('rules-list');
      if (!filtered.length) {
        container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><div>No mock rules yet</div></div>';
        return;
      }
      container.innerHTML = filtered.map(rule => `
        <div class="rule-item">
          <span class="method-badge ${rule.method}">${rule.method}</span>
          <div class="rule-info">
            <div class="rule-url">${rule.url}</div>
            <div class="rule-meta">Status: ${rule.status} · Delay: ${rule.delay}ms</div>
          </div>
          <label class="toggle" onclick="event.stopPropagation()">
            <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRule('${rule.id}')">
            <span class="toggle-track"></span>
            <span class="toggle-thumb"></span>
          </label>
          <button class="btn btn-ghost btn-sm" onclick="editRule('${rule.id}')">Edit</button>
          <button class="btn btn-ghost btn-sm btn-danger" onclick="deleteRule('${rule.id}')">Delete</button>
        </div>
      `).join('');
    }

    function renderLogs() {
      const search = document.getElementById('log-search').value.toLowerCase();
      const method = document.getElementById('log-method-filter').value;
      const mockFilter = document.getElementById('log-mock-filter').value;
      let filtered = logs.filter(log => {
        if (search && !log.url.toLowerCase().includes(search)) return false;
        if (method && log.method !== method) return false;
        if (mockFilter === 'mocked' && !log.isMocked) return false;
        if (mockFilter === 'real' && log.isMocked) return false;
        return true;
      });
      filtered = getDeduplicatedLogs(filtered);
      const container = document.getElementById('logs-list');
      if (!filtered.length) {
        container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg><div>No network requests yet</div></div>';
        return;
      }
      container.innerHTML = filtered.map(log => {
        const statusClass = log.status >= 200 && log.status < 300 ? 'success' : 'error';
        const existingRule = findExistingRule(log.url, log.method);
        return `
          <div class="list-item" onclick="this.classList.toggle('expanded')">
            <div class="item-header">
              <span class="status-code ${statusClass}">${log.status}</span>
              <span class="method-badge ${log.method}">${log.method}</span>
              <span class="item-url">${log.url}</span>
              <span class="tag ${log.isMocked ? 'tag-mock' : 'tag-real'}">${log.isMocked ? 'MOCK' : 'REAL'}</span>
              <div class="item-actions" onclick="event.stopPropagation()">
                ${existingRule 
                  ? `<button class="btn btn-ghost btn-sm" onclick="editRule('${existingRule.id}')">Edit</button>` 
                  : `<button class="btn btn-primary btn-sm" onclick="mockFromLog('${log.id}')">+ Mock</button>`}
              </div>
            </div>
            <div class="item-meta">
              <span>${log.duration}ms</span>
              <span>${log.timestamp}</span>
            </div>
            <div class="item-detail" onclick="event.stopPropagation()">
              ${log.requestBody ? `<div class="detail-section"><div class="detail-label">Request Body</div><div class="detail-content">${formatJSON(log.requestBody)}</div></div>` : ''}
              <div class="detail-section"><div class="detail-label">Response Body</div><div class="detail-content">${formatJSON(log.responseBody)}</div></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatJSON(data) {
      if (!data) return '<span class="json-null">null</span>';
      if (typeof data === 'string') { 
        try { data = JSON.parse(data); } 
        catch { return escapeHtml(data); } 
      }
      return syntaxHighlight(data);
    }

    function syntaxHighlight(json) {
      const str = JSON.stringify(json, null, 2);
      return str.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
            match = match.slice(0, -1) + '</span>:';
            return '<span class="' + cls + '">' + escapeHtml(match.slice(0, -8)) + match.slice(-8);
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + escapeHtml(match) + '</span>';
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function openAddRuleModal() {
      document.getElementById('modal-title').textContent = 'Add Mock Rule';
      document.getElementById('rule-id').value = '';
      document.getElementById('rule-url').value = '';
      document.getElementById('rule-method').value = 'GET';
      document.getElementById('rule-status').value = '200';
      document.getElementById('rule-delay').value = '0';
      document.getElementById('rule-response').value = '';
      document.getElementById('rule-headers').value = '';
      document.getElementById('rule-modal').classList.add('active');
    }

    function editRule(id) {
      const rule = rules.find(r => r.id === id);
      if (!rule) return;
      document.getElementById('modal-title').textContent = 'Edit Mock Rule';
      document.getElementById('rule-id').value = rule.id;
      document.getElementById('rule-url').value = rule.url || '';
      document.getElementById('rule-method').value = rule.method || 'GET';
      document.getElementById('rule-status').value = rule.status || 200;
      document.getElementById('rule-delay').value = rule.delay || 0;
      document.getElementById('rule-response').value = typeof rule.response === 'object' ? JSON.stringify(rule.response, null, 2) : (rule.response || '');
      document.getElementById('rule-headers').value = rule.headers ? JSON.stringify(rule.headers, null, 2) : '';
      document.getElementById('rule-modal').classList.add('active');
    }

    function closeModal() { document.getElementById('rule-modal').classList.remove('active'); }

    function saveRule() {
      const id = document.getElementById('rule-id').value || Date.now().toString(36) + Math.random().toString(36).substr(2);
      let response, headers;
      try { response = JSON.parse(document.getElementById('rule-response').value.trim() || '{}'); }
      catch { alert('Invalid JSON in response body'); return; }
      try { headers = JSON.parse(document.getElementById('rule-headers').value.trim() || '{}'); }
      catch { alert('Invalid JSON in headers'); return; }
      const existingRule = rules.find(r => r.id === id);
      const rule = {
        id, url: document.getElementById('rule-url').value,
        method: document.getElementById('rule-method').value,
        status: parseInt(document.getElementById('rule-status').value) || 200,
        delay: parseInt(document.getElementById('rule-delay').value) || 0,
        response, headers,
        enabled: existingRule ? existingRule.enabled : true,
        createdAt: existingRule ? existingRule.createdAt : Date.now()
      };
      ws.send(JSON.stringify({ type: existingRule ? 'update-rule' : 'add-rule', data: rule }));
      closeModal();
    }

    function toggleRule(id) { ws.send(JSON.stringify({ type: 'toggle-rule', data: id })); }
    function deleteRule(id) { if (confirm('Delete this rule?')) ws.send(JSON.stringify({ type: 'delete-rule', data: id })); }
    function clearLogs() { ws.send(JSON.stringify({ type: 'clear-logs' })); }

    function mockFromLog(id) {
      const log = logs.find(l => l.id === id);
      if (!log) return;
      document.getElementById('modal-title').textContent = 'Create Mock Rule';
      document.getElementById('rule-id').value = '';
      document.getElementById('rule-url').value = log.url || '';
      document.getElementById('rule-method').value = log.method || 'GET';
      document.getElementById('rule-status').value = log.status || 200;
      document.getElementById('rule-delay').value = '0';
      document.getElementById('rule-response').value = typeof log.responseBody === 'object' ? JSON.stringify(log.responseBody, null, 2) : (log.responseBody || '');
      document.getElementById('rule-headers').value = '';
      document.getElementById('rule-modal').classList.add('active');
    }

    document.getElementById('rule-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeModal();
    });
  </script>
</body>
</html>
